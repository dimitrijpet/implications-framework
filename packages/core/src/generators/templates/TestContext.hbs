// Auto-generated by Implications Framework
// Location: {{outputPath}}

/**
 * TestContext - Manages test data and state transitions
 * 
 * This class handles:
 * - Loading test data from JSON files (master or delta)
 * - Automatic delta file creation/management
 * - Providing config for actions (device, lang, etc.)
 * - Tracking state changes (delta)
 * - Validating prerequisites
 * - Saving updated state to delta file (NEVER overwrites master)
 * 
 * FILE STRATEGY:
 * - Master files: *-master.json (read-only, pristine)
 * - Delta files: *-current.json (created automatically, tracks changes)
 * 
 * When you load "flight-booking-master.json":
 * - Checks if "flight-booking-current.json" exists
 * - If yes: loads from current (delta)
 * - If no: loads from master, will save to current
 * - Master file is NEVER modified
 */
class TestContext {
  constructor(ImplicationClass, testData, actualFilePath) {
    this.ImplicationClass = ImplicationClass;
    this.data = testData;
    this.changeLog = [];
    this.actualFilePath = actualFilePath; // The file we actually loaded from
    
    // ‚úÖ Create config object from test data
    this.config = {
      device: testData.device || testData._config?.device || 'desktop',
      lang: testData.lang || testData._config?.lang || 'en',
      carrier: testData.carrier || testData._config?.carrier || 'LCC',
      debugMode: testData.debugMode || testData._config?.debugMode || false,
      baseURL: testData._config?.baseURL,
      // Spread any additional config fields
      ...testData._config
    };
    
    // ‚úÖ Initialize wrappers storage (for page object wrappers)
    this.wrappers = {};
    
    // ‚úÖ Initialize domain-specific data storage (bookings, flights, etc.)
    this.bookingData = {};
    this.flightData = {};
    
    // ‚úÖ Initialize runtime data (NOT saved - ephemeral)
    this.runtime = {
      price: null,
      indexStart: 0,
      orderId: null
    };
  }
  
  /**
   * Determine the delta file path from a given path
   * 
   * @param {string} inputPath - Path provided by user
   * @returns {string} Delta file path
   * 
   * Examples:
   * - "tests/data/flight-booking-master.json" ‚Üí "tests/data/flight-booking-current.json"
   * - "tests/data/shared-master.json" ‚Üí "tests/data/shared-current.json"
   * - "tests/data/current.json" ‚Üí "tests/data/current.json" (already delta)
   */
  static getDeltaPath(inputPath) {
    if (inputPath.includes('-master.')) {
      return inputPath.replace('-master.', '-current.');
    }
    
    // If already ends with -current.json, use as-is
    if (inputPath.includes('-current.')) {
      return inputPath;
    }
    
    // If no master/current suffix, add -current before extension
    return inputPath.replace('.json', '-current.json');
  }
  
  /**
   * Load test data from JSON file with automatic delta handling
   * 
   * SMART LOADING:
   * 1. If input path has "-master.json", check for corresponding "-current.json"
   * 2. If current exists, load from there (contains accumulated changes)
   * 3. If current doesn't exist, load from master (fresh start)
   * 4. Saves ALWAYS go to current file (master stays pristine)
   * 
   * @param {ImplicationClass} ImplicationClass - The Implication class
   * @param {string} testDataPath - Path to test data (can be master or current)
   * @returns {TestContext} Test context with loaded data
   */
  static load(ImplicationClass, testDataPath) {
    const fs = require('fs');
    const path = require('path');
    
    let actualPath = testDataPath;
    let isMasterFile = testDataPath.includes('-master.');
    
    // ‚úÖ Smart delta detection
    if (isMasterFile) {
      const deltaPath = this.getDeltaPath(testDataPath);
      
      if (fs.existsSync(deltaPath)) {
        actualPath = deltaPath;
        console.log(`   üìÇ Loading from delta file: ${path.basename(deltaPath)}`);
      } else {
        console.log(`   üìÇ Loading from master file: ${path.basename(testDataPath)}`);
        console.log(`   üí° Will create delta file: ${path.basename(deltaPath)}`);
      }
    } else {
      console.log(`   üìÇ Loading from: ${path.basename(testDataPath)}`);
    }
    
    // Read the file
    const fileData = JSON.parse(fs.readFileSync(actualPath, 'utf8'));
    
    // Handle both formats:
    // Format 1: { "status": "initial", "agencyId": "..." }  (fresh file)
    // Format 2: { "_original": {...}, "_changeLog": [...] } (saved file with history)
    
    let testData, changeLog;
    
    if (fileData._original) {
      // Load from saved format with history
      testData = fileData._original;
      changeLog = fileData._changeLog || [];
      
      // ‚úÖ Apply all deltas to get current state
      for (const change of changeLog) {
        for (const [key, value] of Object.entries(change.delta)) {
          testData[key] = value;
        }
      }
      
      console.log(`   üìä Applied ${changeLog.length} changes from history`);
      console.log(`   üéØ Current state: ${testData.status || 'unknown'}`);
    } else {
      // Load from fresh format (master file)
      testData = fileData;
      changeLog = [];
      console.log(`   ‚ú® Fresh state loaded`);
    }
    
    // Create context with the actual file path we loaded from
    const ctx = new TestContext(ImplicationClass, testData, actualPath);
    ctx.changeLog = changeLog;
    
    // Store the original input path for save logic
    ctx.inputPath = testDataPath;
    
    return ctx;
  }
  
  /**
   * Execute action and save changes
   * 
   * This updates the in-memory data and adds to changelog.
   * Call .save() to persist to disk.
   */
  async executeAndSave(label, testFile, deltaFn) {
    const { delta } = await deltaFn();
    
    // Apply delta to data
    for (const [key, value] of Object.entries(delta)) {
      this.data[key] = value;
    }
    
    // Log change
    this.changeLog.push({
      label,
      testFile,
      delta,
      timestamp: new Date().toISOString()
    });
    
    return this;
  }
  
  /**
   * Save updated data to delta file (NEVER to master)
   * 
   * SAVE STRATEGY:
   * - If input was master file, save to corresponding current file
   * - If input was already current file, save to same file
   * - Master files are NEVER modified
   * 
   * SAVED FORMAT:
   * {
   *   "_original": { ...initial state from master... },
   *   "_changeLog": [
   *     { label, testFile, delta, timestamp },
   *     ...
   *   ]
   * }
   * 
   * @param {string} testDataPath - Optional override path (usually not needed)
   */
  save(testDataPath) {
    const fs = require('fs');
    const path = require('path');
    
    // Determine where to save
    let savePath;
    
    if (testDataPath) {
      // Explicit path provided - use delta version of it
      savePath = TestContext.getDeltaPath(testDataPath);
    } else if (this.inputPath) {
      // Use delta version of original input path
      savePath = TestContext.getDeltaPath(this.inputPath);
    } else {
      // Fallback: use actual path we loaded from
      savePath = this.actualFilePath;
    }
    
    // Get the original master data (before any changes)
    const originalData = { ...this.data };
    
    // Rewind all changes to get original
    for (let i = this.changeLog.length - 1; i >= 0; i--) {
      const change = this.changeLog[i];
      for (const key of Object.keys(change.delta)) {
        // Remove fields that were added by deltas
        delete originalData[key];
      }
    }
    
    // If we started from master, use master data as original
    if (this.changeLog.length === 0) {
      // No changes yet, original = current data
    }
    
    // Read original from master if available
    const masterPath = this.inputPath || testDataPath;
    if (masterPath && masterPath.includes('-master.') && fs.existsSync(masterPath)) {
      const masterData = JSON.parse(fs.readFileSync(masterPath, 'utf8'));
      Object.assign(originalData, masterData);
    }
    
    // Save with _original and _changeLog structure
    const output = {
      _original: originalData,
      _changeLog: this.changeLog
    };
    
    fs.writeFileSync(savePath, JSON.stringify(output, null, 2));
    
    const fileName = path.basename(savePath);
    const isMaster = savePath.includes('-master.');
    
    if (isMaster) {
      console.log(`   ‚ö†Ô∏è  WARNING: Saved to master file: ${fileName}`);
    } else {
      console.log(`   üíæ Saved to delta file: ${fileName}`);
    }
  }
}

module.exports = TestContext;
