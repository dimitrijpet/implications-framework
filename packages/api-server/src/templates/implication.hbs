// Auto-generated by Implications Framework
// Created: {{timestamp}}

{{#if composedBehaviors}}
// Composed behaviors
{{#each composedBehaviors}}
const {{className}} = require('{{relativePath}}');
{{/each}}

{{/if}}
{{#if baseClass}}
// Base class
const {{baseClass.className}} = require('{{baseClass.relativePath}}');
{{/if}}
{{#if helpers.needsImplicationHelper}}
const ImplicationHelper = require('{{{helpers.implicationHelperPath}}}');
{{/if}}

/**
 * {{className}}
 * {{#if description}}
 * {{description}}
 * {{/if}}
 * 
 * Status: {{meta.status}}
 * Platform: {{meta.platform}}
 */
class {{className}} {
  
  static xstateConfig = {
    id: '{{stateId}}',
    
    meta: {
      status: '{{meta.status}}',
      {{#if meta.platform}}
      platform: '{{meta.platform}}',
      {{/if}}
      {{#if meta.statusLabel}}
      statusLabel: '{{meta.statusLabel}}',
      {{/if}}
      {{#if meta.triggerButton}}
      triggerButton: '{{meta.triggerButton}}',
      {{/if}}
      {{#if meta.triggerAction}}
      triggerAction: '{{meta.triggerAction}}',
      {{/if}}
      {{#if meta.requiredFields}}
      requiredFields: [{{#each meta.requiredFields}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
      {{/if}}
      {{#if meta.requires}}
      requires: {
        {{#if meta.requires.previousStatus}}
        previousStatus: '{{meta.requires.previousStatus}}'
        {{/if}}
      },
      {{/if}}
      {{#if platforms}}
      setup: [
        {{#each platforms}}
        {
          testFile: '{{testFile}}',
          actionName: '{{actionName}}',
          platform: '{{platform}}'
        }{{#unless @last}},{{/unless}}
        {{/each}}
      ]
      {{else}}
      setup: [{
        testFile: 'tests/implications/bookings/status/{{className}}-{{capitalize meta.platform}}-UNIT.spec.js',
        actionName: '{{#if meta.triggerAction}}{{meta.triggerAction}}{{else}}{{stateId}}{{/if}}',
        platform: '{{meta.platform}}'
      }]
      {{/if}}
    },
    
    on: {
      // TODO: Add state transitions
      // Example:
      // UNDO: 'pending',
      // CANCEL: 'cancelled'
    }
    
    {{#if hasEntry}}
    ,
    entry: {
      status: '{{meta.status}}',
      {{#if meta.statusLabel}}
      statusLabel: '{{meta.statusLabel}}',
      {{/if}}
      {{#if meta.statusCode}}
      statusCode: '{{meta.statusCode}}',
      {{/if}}
      // Add timestamp or other delta fields here
    }
    {{/if}}
  };
  
  static mirrorsOn = {
    {{#if description}}
    description: '{{description}}',
    {{/if}}
    
    triggeredBy: [{
      description: 'Trigger {{meta.status}} state',
      platform: '{{meta.platform}}',
      action: async (testDataPath, options = {}) => {
        const { {{#if meta.triggerAction}}{{meta.triggerAction}}{{else}}{{stateId}}{{/if}} } = require('./{{className}}-{{capitalize meta.platform}}-UNIT.spec.js');
        return {{#if meta.triggerAction}}{{meta.triggerAction}}{{else}}{{stateId}}{{/if}}(testDataPath, options);
      }
    }],
    
  UI: {
  {{#if meta.platform}}
  {{meta.platform}}: {
    {{#if screens}}
    {{#each screens}}
    {{@key}}: [{{#if this.[0].extendsBase}}ImplicationHelper.mergeWithBase(  {{!-- ✅ Add [ here --}} {{!-- ✅ FIXED --}}
      BaseBookingImplications.{{../sourcePlatform}}.{{@key}},
      {
        {{#if this.[0].description}}
        description: '{{this.[0].description}}',
        {{/if}}
        {{#if this.[0].visible}}
        visible: [{{#each this.[0].visible}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        {{/if}}
        {{#if this.[0].hidden}}
        hidden: [{{#each this.[0].hidden}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        {{/if}}
          {{! ✅ ADD THIS: Functions block }}
    {{#if this.[0].functions}}
    functions: {
      {{#each this.[0].functions}}
      {{@key}}: {
        {{#if this.signature}}
        signature: '{{this.signature}}',
        {{/if}}
        {{#if this.parameters}}
        parameters: {
          {{#each this.parameters}}
          {{@key}}: '{{this}}'{{#unless @last}},{{/unless}}
          {{/each}}
        }
        {{/if}}
      }{{#unless @last}},{{/unless}}
      {{/each}}
    },
    {{/if}}
        {{#if this.[0].checks}}
        checks: {
          {{#if this.[0].checks.visible}}
          visible: [{{#each this.[0].checks.visible}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]{{#if this.[0].checks.hidden}},{{/if}}
          {{/if}}
          {{#if this.[0].checks.hidden}}
          hidden: [{{#each this.[0].checks.hidden}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]{{#if this.[0].checks.text}},{{/if}}
          {{/if}}
          {{#if this.[0].checks.text}}
          text: {
            {{#each this.[0].checks.text}}
            {{@key}}: '{{this}}'{{#unless @last}},{{/unless}}
            {{/each}}
          }
          {{/if}}
        }
        {{/if}}
      },
      { parentClass: {{../className}} }
    )]{{else}}[  {{!-- ✅ Add ] here --}}
      {
        screen: (app) => app.{{@key}},  {{!-- ✅ Use @key here too --}}
        
        prerequisites: [{
          description: 'Navigate to {{@key}}',
          setup: async (testData, app) => {
            // TODO: Add navigation logic
          }
        }],
        
        expect: async (testData, screen) => {
          // TODO: Add custom validation logic
        }
      }
    ]{{/if}}{{#unless @last}},{{/unless}}
    
    {{/each}}
    {{else}}
    // TODO: Add screen definitions
    {{/if}}
  }
  {{/if}}
}
  };
  static meta = {
    status: '{{meta.status}}',
    {{#if meta.platform}}
    platform: '{{meta.platform}}',
    {{/if}}
    {{#if meta.statusLabel}}
    statusLabel: '{{meta.statusLabel}}',
    {{/if}}
    {{#if meta.triggerButton}}
    triggerButton: '{{meta.triggerButton}}'
    {{/if}}
  };
}

module.exports = {{className}};